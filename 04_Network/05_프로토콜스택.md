# Protocol Stack

브라우저가 OS에서 의뢰하여 통신을 한다는 것을 알아보았다.

그럼 그 OS에서는 어떻게 동작하는지 알아보자. 

앞에서 대충 구조만 알았던 TCP/IP, Socket, Lan등에 대해 좀 더 자세히 들여다 보자



### 구조

> 네트워크 어플리케이션 (웹 브라우저, 메일러, 웹 서버 등)
>
> - Socket라이브러리의 리졸버를 통해 DNS서버에 조회

​							⬇

> 프로토콜 스택
>
> - TCP : 브라우저나 메일등의 일반적인 어플리케이션이 데이터를 송·수신할 때 사용되는 프로토콜
> - UDP : DNS 서버에 대한 조회처럼 짧은 제어용 데이터를 송·수신 할 때 사용되는 프로토콜
> - IP *(ICMP,ARP)* : 패킷의 송·수신 동작을 제어할 때 사용되는 프로토콜
>
> *패킷 : 데이터 운반시 작게 나누어 분할된 데이터덩어리*

​							⬇

> ​	LAN 드라이버

​							⬇

​							...

### 동작

프로토콜 스택이 어떻게, 어디로, 언제 통신할 지와 같은 통신에 대한 동작은 소켓을 참조한다. 앞서 살펴봤듯이 Socket라이브러리의 `connect()`나 `socket()`을 통해 소켓이 생성된다. 프로토콜 스택이 동작하면 최초로 실행하는 일이 소켓 한 개 분량의 메모리를 확보하고, 그 영역에 제어 정보를 저장한다. 생성된 직후에는 `초기 상태`라는 정보를 기록한다. 소켓에는 통신 상대의 IP주소, 포트 번호, 통신 동작의 진행 상태등 통신동작에 대한 제어정보를 가지고 있다. 프로토콜 스택은 이를 참조하며 동작한다.

예)

| num  | Proto | Local Address     | Foreign Address   | State       | PID  |
| :--- | ----- | ----------------- | ----------------- | ----------- | ---- |
| 1    | TCP   | 0.0.0.0:135       | 0.0.0.0:0         | Listening   | 1200 |
| 2    | TCP   | 118.42.2.212:2477 | 222.233.53.144:80 | Established | 1720 |
| 3    | UDP   | 0.0.0.0:445       | \*:\*             |             | 4    |

1번을 보면 `PID`가 1200인 프로그램이 135번 포트에 `TCP`를 통한 통신을 기다리고 있고, (Listening의 경우 통신이 시작되지 않아 IP주소가 정해지지 않음)

2번을 보면 `PID`가 1720인 프로그램이 `118.42.2.212`라는 IP주소를 할당한 LAN을 사용하여 IP주소가 `118.42.2.212`인 상대와 통신중이다. 



*PID*는 소켓을 사용하고 있는 프로그램의 식별 번호이다. (Program ID)