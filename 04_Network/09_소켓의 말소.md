# 연결 끊기

클라이언트와 서버와의 데이터 송,수신이 끝나면, 연결을 끊기 시작한다.

보통 요청한 데이터를 전송해주는 서버측에서 연결 끊기 단계에 돌입하지만, 항상 그런것은 아니다.

일단은, 서버측에서 연결 끊기 단계에 돌입하는 경우를 살펴보자.

우선 서버측에서 데이터 전송이 모두 완료되었다고 판단되었을때 시작한다. 이 역시 Socket라이브러리에서 `close()`를 호출하여 TCP헤더를 만들고, 연결을 끊으려고 한다는 정보를 담는다. (FIN 비트에 1을 설정) 그 후 IP프로토콜을 거쳐 클라이언트에 송신을 한다. 동시에, 소켓에 연결 끊기 동작을 하고 있다는 정보를 담는다.

이제, 잘 연결되어있던 커넥션을 통해 전달된 연결 끊기의 정보(FIN 비트가 1)가 담긴 TCP헤더를 받은 클라이언트 측을 살펴보자. 이 TCP헤더가 도착하면, 클라이언트측 역시 소켓에 연결 끊기 동작을 하고 있다는 정보를 담는다. 그리고 기존 데이터 송,수신과 동일하게 수신완료의 의미인 ACK 번호를 반송한다.

이제 어플리케이션이 `read()`를 통해 클라이언트 측의 소켓에 담겨있는 데이터를 가지러 오면, 데이터를 건네지 않고 서버의 데이터 수신이 완료되었다는 사실을 알려준다. 이를 통해 어플리케이션(웹)은 `close()`를 호출하여 데이터 송,수신 동작을 끝내고, 클라이언트측의 프로토콜 스택 역시 서버측과 마찬가지로 FIN 비트를 통해 서버측과 송신하여 소켓을 말소한다.

이때 소켓의 말소는 바로 이루어지지 않는다. 소켓이 바로 말소되면, ACK 번호가 송신이 되기 전에 닫혀버리는 경우처럼 여러 오작동의 원인이 될 수 있기 때문이다. 명확한 규칙은 없지만, 보통 몇 분 정도 기다린다고 한다.