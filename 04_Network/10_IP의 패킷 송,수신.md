# IP의 패킷 송수신

TC담당 부분은 통신하는 동작의 대부분을 IP담당 부분에 의뢰하여 한다고 하였다. 이때 IP 담당 부분에서 이루어지는 일들을 살펴보려고 한다.



### 패킷의 구성

패킷은 '헤더'와 '데이터'의 두 부분으로 구성된다.

'헤더'에는 수신처를 나타내는 주소 등의 제어 정보가, '데이터'에는 데이터가 들어가 있다.



### 패킷 송신

IP담당 부분이 의뢰받은 패킷을 상대에게 전달하는 것. 사실 패킷을 송출하기만 하면, 허브나 라우터가 패킷의 헤더를 통해 상대의 주소를 알아내 송신한다.

TCP 담당 부분에서 데이터의 조각에 TCP헤더를 붙혀 IP 담당 부분에 건네준다. *TCP헤더 + 데이터 조각*이 패킷의 내용물이 되며 통신 상대의 IP주소를 나타낸다.

송신의 의뢰를 받은 IP 담당 부분에서는 추가적으로 *IP헤더와 MAC헤더*를 붙힌다. IP헤더는  IP주소로 표시된 목적지까지 패킷을 전달할 때 사용하는 제어 정보를 기록한 것이고, MAC헤더는 LAN을 사용하여 가장 가까운 라우터까지 패킷을 운반할 때 사용하는 제어 정보가 기록되어 있다.

이렇게  *MAC헤더 + IP헤더 + TCP헤더 + 데이터 조각*으로 이루어진 패킷을 네트워크용 하드웨어(이더넷, 무선LAN 등)에 건네준다. 이때, 0과 1로 이루어진 디지털 데이터로 건네어 전기나 빛의 신호 상태를 통해 케이블로 송출된다. 이 신호가 허브나 라우터 등의 중계장치에 도착해 송신이 이루어진다.



### 패킷 수신

위 과정이 역순으로 이루어진다.

1. 디지털 신호를 네트워크용 하드웨어가 디지털 데이터의 모습인  패킷으로  되돌리고,
2. IP 담당 부분에 건네준다.
3. IP 담당 부분에서 IP헤더와 MAC헤더를 제외하고,
4. TCP 담당 부분에 TCP헤더와 데이터 조각을 건네준다.



### IP헤더

IP 담당 부분에서 TCP 담당 부분으로부터 의뢰 받은 데이터에  *IP헤더* 를 덧붙힌다.

IP헤더는 여러 필드들이 있다.

- 버전, 헤더의 길이, 프로토콜 번호, ...
- 송신처 IP 주소, 수신처 IP 주소, ...

##### **수신처 IP주소** 필드 설정

어플리케이션으로부터 통지된 수신처 IP주소를 TCP 담당 부분이 TCP가 접속 동작을 실행할 때 건네받아 IP 담당 부분에 전달해 준다. 이 IP주소를 그대로 IP헤더에 지정한다.

##### **송신처 IP주소** 필드 설정

현재 컴퓨터에 할당된 IP주소를 설정한다. 하지만, 여러 개의 LAN 어댑터가 장착되어 있으면, 현재 컴퓨터에 할당된 IP주소가 하나 이상이다. 이때 어떤 LAN 어댑터를 사용해야 하는 지 판단해야 하는데, 이것은 곧 패킷을 건네주는 상대의 라우터를 결정하는 것과 같다. 이를 판단할 때, 라우팅 테이블이 필요하다. 통신하려는 상대의 IP 주소를 기준으로, 라우팅 테이블의 `Network Destination` , `Interface`,  `Gateway` 등 여러 항목을 비교해보며 결정한다. 

##### 프로토콜 번호 필드 설정

패킷에 들어간 내용이 어디에서 의뢰받은 것인지를 나타낸다. TCP에게 의뢰받았다면 06(16진수), UDP에서 의뢰받았다면 17(16진수)라는 식의 값을 설정한다.

​	

### MAC헤더

IP 담당 부분에서 IP헤더 뿐만 아니라 *MAC헤더* 도 덧붙힌다. 이더넷에는 TCP/IP의 개념이 통용되지 않기 때문에 MAC헤더를 통해 수신처 판단 구조를 제공해야 한다.

MAC헤더는 이더넷에서 사용하는 헤더로서 수신처와 송신처의 MAC주소가 기록되어있다.

##### MAC헤더 필드

- 송신처 MAC 주소
- 수신처 MAC 주소
- 이더 타입 : 사용하는 프로토콜의 종류
  1. 0800 ( IP프로토콜 )
  2. 0806 ( ARP프로토콜 )
  3. 0800 ( IPv6 )

##### 이더 타입 필드 

 IP헤더의 프로토콜 필드와 비슷하다. MAC헤더 뒤로 이어지는 패킷 내 내용물이 무엇인지를 나타낸다. 

##### 송신처 MAC 주소 필드

IP헤더와 비슷하게 LAN어댑터의 MAC주소를 사용하고, 하나 이상이면 어느 LAN어댑터에서 송신할 지 판단하고 할당한다.

##### 수신처 MAC 주소 필드

우선 IP주소를 통해 IP헤더 생성에서 사용된 라우팅 테이블의 `Gateway`항목을 비교하여 패킷을 건네줄 상대를 찾는다. 그 상대의 MAC주소를 수신처 MAC 주소 필드에 설정하면 된다. 하지만, 어플리케이션으로터 전달받은 IP주소를 사용하는 IP헤더와 달리, MAC주소는 패킷을 건네줄 상대의 IP주소를 통해 조사하여야 한다. ARP(Address Resolution Protocol)이 사용된다.



### 패킷의 전달

IP담당 부분이 위의 과정을 거쳐 패킷을 만들면 LAN어댑터로 건네주기만 하면 된다. 이더넷과 IP는 연관되어 있지 않지만, IP담당 부분에서 같이 처리하는 이유는 어떤 종류의 패킷이더라도 IP 담당 부분만 거치면 LAN어댑터를 통해 송신이 가능하기 때문이다.

LAN어댑터 입장에서는 어떤 형식의 패킷이더라도 IP담당부분에서 건네준 것을 송신하는 역할만 하면 되기 때문에 대응력이 좋고 현실적이다.





